<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Version Control App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font to the body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #374151; /* Dark gray text color */
        }
        /* Styling for the code display area */
        .code-container {
            background-color: #1a202c; /* Dark background for code */
            color: #cbd5e0; /* Light text color for code */
            padding: 1rem;
            border-radius: 0.5rem; /* Rounded corners */
            overflow-x: auto; /* Enable horizontal scrolling for long lines */
            font-family: 'JetBrains Mono', 'Fira Code', monospace; /* Monospace font for code */
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); /* Inner shadow for depth */
        }
        pre {
            margin: 0;
            white-space: pre-wrap; /* Wrap long lines of code */
            word-break: break-all; /* Break words if necessary to fit */
        }
        /* Custom scrollbar for the code container for better aesthetics */
        .code-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .code-container::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track */
            border-radius: 10px;
        }
        .code-container::-webkit-scrollbar-thumb {
            background: #4a5568; /* Lighter thumb */
            border-radius: 10px;
        }
        .code-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Even lighter on hover */
        }

        /* Styling for buttons to add a subtle shadow and transition */
        button {
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Styling for list items to add subtle shadow and transition */
        .list-item {
            transition: all 0.2s ease;
        }
        .list-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header Section -->
    <header class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 shadow-lg">
        <h1 class="text-3xl font-bold text-center">Version Control System</h1>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Panel: Applications List -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Applications</h2>
            <!-- Button to add a new application -->
            <button id="addNewAppBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 mb-4 w-full">
                Add New Application
            </button>
            <!-- Container for the list of applications -->
            <div id="applicationsList" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                <!-- Placeholder for loading state -->
                <div class="text-gray-500 text-center py-4">Loading applications...</div>
            </div>
        </section>

        <!-- Middle Panel: Versions List -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Versions for <span id="currentAppName" class="font-bold text-blue-600">No App Selected</span></h2>
            <!-- Container for the list of versions -->
            <div id="versionsList" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                <!-- Placeholder for initial state -->
                <div class="text-gray-500 text-center py-4">Select an application to see versions.</div>
            </div>
        </section>

        <!-- Right Panel: Code Editor & Viewer -->
        <section class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-1">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Code Editor & Viewer</h2>

            <!-- Input for Version Notes -->
            <div class="mb-4">
                <label for="versionNotesInput" class="block text-gray-700 text-sm font-bold mb-2">Version Notes:</label>
                <input type="text" id="versionNotesInput" placeholder="e.g., 'Initial commit', 'Bug fix for login'" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
            </div>

            <!-- Textarea for Code Input -->
            <div class="mb-4">
                <label for="codeEditor" class="block text-gray-700 text-sm font-bold mb-2">Code:</label>
                <textarea id="codeEditor" rows="15" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 font-mono text-sm" placeholder="Paste your HTML, CSS, JS, or JSON code here..."></textarea>
            </div>

            <!-- Action Buttons for Code Editor -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <button id="saveVersionBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex-grow">
                    Save New Version
                </button>
                <button id="copyCodeBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex-grow">
                    Copy Displayed Code
                </button>
            </div>

            <!-- Code Viewer Area -->
            <h3 class="text-xl font-semibold mb-3 text-gray-800">Displayed Code:</h3>
            <div id="codeViewer" class="code-container min-h-[150px]">
                <pre><code id="displayedCode">Select a version to view its code.</code></pre>
            </div>
        </section>
    </main>

    <!-- Modal for Add New App -->
    <div id="addNewAppModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Add New Application</h3>
            <div class="mb-4">
                <label for="newAppNameInput" class="block text-gray-700 text-sm font-bold mb-2">Application Name:</label>
                <input type="text" id="newAppNameInput" placeholder="e.g., 'My Blog App'" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelNewAppBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                <button id="confirmNewAppBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Add Application</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Message Box (instead of alert()) -->
    <div id="messageBox" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50 transition-opacity duration-300 opacity-0">
        <span id="messageContent"></span>
    </div>

    <!-- Firebase SDK and custom script -->
    <script type="module">
        // Import necessary Firebase functions from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, getDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Your web app's Firebase configuration (provided by the user)
        const firebaseConfig = {
            apiKey: "AIzaSyD7I9ZKYFTc71tFMGA2lM72ykwDuwhEV0o",
            authDomain: "tudien-b2d17.firebaseapp.com",
            projectId: "tudien-b2d17",
            storageBucket: "tudien-b2d17.firebasestorage.app",
            messagingSenderId: "496472238606",
            appId: "1:496472238606:web:79769d3c38e546a27dea5f"
        };

        // Initialize Firebase app and get Firestore and Auth instances
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global state variables for the application
        let currentAppId = null; // Stores the ID of the currently selected application
        let currentAppName = null; // Stores the name of the currently selected application
        let userId = null; // Stores the authenticated user's ID
        let isAuthReady = false; // Flag to indicate if Firebase authentication is ready

        // Get references to DOM elements
        const applicationsList = document.getElementById('applicationsList');
        const versionsList = document.getElementById('versionsList');
        const currentAppNameSpan = document.getElementById('currentAppName');
        const codeEditor = document.getElementById('codeEditor');
        const versionNotesInput = document.getElementById('versionNotesInput');
        const displayedCode = document.getElementById('displayedCode');
        const saveVersionBtn = document.getElementById('saveVersionBtn');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const addNewAppBtn = document.getElementById('addNewAppBtn');
        const addNewAppModal = document.getElementById('addNewAppModal');
        const newAppNameInput = document.getElementById('newAppNameInput');
        const confirmNewAppBtn = document.getElementById('confirmNewAppBtn');
        const cancelNewAppBtn = document.getElementById('cancelNewAppBtn');
        const messageBox = document.getElementById('messageBox');
        const messageContent = document.getElementById('messageContent');

        /**
         * Displays a custom message box instead of the native alert().
         * @param {string} message - The message to display.
         * @param {number} duration - How long to display the message in milliseconds.
         */
        function showMessage(message, duration = 3000) {
            messageContent.textContent = message;
            messageBox.classList.remove('hidden', 'opacity-0');
            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300); // Allow fade-out transition to complete
            }, duration);
        }

        // --- Firebase Authentication ---
        // Listen for authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                userId = user.uid;
                console.log("Authenticated as:", userId);
            } else {
                // No user is signed in, attempt to sign in
                try {
                    // Check if __initial_auth_token is available (provided by Canvas environment)
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        userId = auth.currentUser.uid;
                        console.log("Signed in with custom token:", userId);
                    } else {
                        // If no custom token, sign in anonymously
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                        console.log("Signed in anonymously:", userId);
                    }
                } catch (error) {
                    console.error("Authentication error:", error);
                    // Fallback: If authentication fails, use a random UUID as a temporary user ID.
                    // Note: Data saved with a random UUID will not be tied to a persistent user session.
                    userId = crypto.randomUUID();
                    console.warn("Using a random userId due to authentication error:", userId);
                    showMessage("Authentication failed. Using a temporary ID. Data might not persist across sessions.", 5000);
                }
            }
            isAuthReady = true; // Set flag to true once authentication is handled
            // Once authentication is ready, load the applications
            if (isAuthReady) {
                loadApplications();
            }
        });

        // --- Firestore Data Paths ---
        // Get the Canvas app ID for data isolation. If not defined, use a default ID.
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-version-control-app';

        /**
         * Returns the Firestore collection reference for applications.
         * Data is stored publicly under `/artifacts/{appId}/public/data/applications`.
         * @returns {firebase.firestore.CollectionReference}
         */
        const getApplicationsCollectionRef = () => {
            return collection(db, `artifacts/${canvasAppId}/public/data/applications`);
        };

        /**
         * Returns the Firestore collection reference for versions of a specific application.
         * Versions are sub-collections of applications.
         * @param {string} appId - The ID of the application.
         * @returns {firebase.firestore.CollectionReference}
         */
        const getVersionsCollectionRef = (appId) => {
            return collection(db, `artifacts/${canvasAppId}/public/data/applications/${appId}/versions`);
        };

        /**
         * Returns the Firestore collection reference for files of a specific version.
         * Files are sub-collections of versions.
         * @param {string} appId - The ID of the application.
         * @param {string} versionId - The ID of the version.
         * @returns {firebase.firestore.CollectionReference}
         */
        const getFilesCollectionRef = (appId, versionId) => {
            return collection(db, `artifacts/${canvasAppId}/public/data/applications/${appId}/versions/${versionId}/files`);
        };

        // --- UI Rendering Functions ---

        /**
         * Loads and displays the list of applications from Firestore.
         * Uses `onSnapshot` for real-time updates to the UI.
         */
        async function loadApplications() {
            if (!isAuthReady) {
                // If authentication is not ready, display a message and return
                applicationsList.innerHTML = '<div class="text-gray-500 text-center py-4">Waiting for authentication...</div>';
                return;
            }

            applicationsList.innerHTML = '<div class="text-gray-500 text-center py-4">Loading applications...</div>';

            try {
                // Create a query to order applications by name
                const q = query(getApplicationsCollectionRef(), orderBy('name'));

                // Set up a real-time listener for application changes
                onSnapshot(q, (snapshot) => {
                    applicationsList.innerHTML = ''; // Clear the current list
                    if (snapshot.empty) {
                        applicationsList.innerHTML = '<div class="text-gray-500 text-center py-4">No applications found. Add a new one!</div>';
                        return;
                    }
                    // Iterate through each application document and create a UI element
                    snapshot.forEach(doc => {
                        const app = doc.data();
                        const appItem = document.createElement('div');
                        appItem.id = `app-${doc.id}`; // Unique ID for the app item
                        appItem.className = 'list-item bg-gray-100 hover:bg-blue-100 p-3 rounded-lg cursor-pointer transition duration-200 shadow-sm flex justify-between items-center';
                        appItem.innerHTML = `
                            <span class="font-medium text-gray-700">${app.name}</span>
                            <span class="text-sm text-gray-500">ID: ${doc.id.substring(0, 8)}...</span>
                        `;
                        // Attach click event to select the application
                        appItem.onclick = () => selectApplication(doc.id, app.name);
                        applicationsList.appendChild(appItem);
                    });

                    // If an application was previously selected, re-highlight it
                    if (currentAppId) {
                        const selectedAppElement = document.getElementById(`app-${currentAppId}`);
                        if (selectedAppElement) {
                            selectedAppElement.classList.remove('bg-gray-100');
                            selectedAppElement.classList.add('bg-blue-200', 'border-blue-500', 'border-2');
                        }
                    }
                });
            } catch (error) {
                console.error("Error loading applications:", error);
                applicationsList.innerHTML = '<div class="text-red-500 text-center py-4">Error loading applications.</div>';
                showMessage("Error loading applications.", 4000);
            }
        }

        /**
         * Selects an application, updates the UI, and loads its versions.
         * @param {string} appId - The ID of the selected application.
         * @param {string} appName - The name of the selected application.
         */
        async function selectApplication(appId, appName) {
            currentAppId = appId;
            currentAppName = appName;
            currentAppNameSpan.textContent = appName; // Update the app name in the versions panel header
            console.log(`Selected application: ${appName} (ID: ${appId})`);

            // Remove highlight from all application items
            document.querySelectorAll('#applicationsList > div').forEach(item => {
                item.classList.remove('bg-blue-200', 'border-blue-500', 'border-2');
                item.classList.add('bg-gray-100');
            });
            // Add highlight to the newly selected application item
            const selectedAppElement = document.getElementById(`app-${appId}`);
            if (selectedAppElement) {
                selectedAppElement.classList.remove('bg-gray-100');
                selectedAppElement.classList.add('bg-blue-200', 'border-blue-500', 'border-2');
            }

            // Load versions for the selected application
            loadVersions(appId);
            // Clear the code editor and viewer when a new app is selected
            codeEditor.value = '';
            versionNotesInput.value = '';
            displayedCode.textContent = 'Select a version to view its code.';
        }

        /**
         * Loads and displays versions for the selected application from Firestore.
         * Uses `onSnapshot` for real-time updates.
         * @param {string} appId - The ID of the application.
         */
        async function loadVersions(appId) {
            if (!isAuthReady || !appId) {
                versionsList.innerHTML = '<div class="text-gray-500 text-center py-4">Select an application to see versions.</div>';
                return;
            }

            versionsList.innerHTML = '<div class="text-gray-500 text-center py-4">Loading versions...</div>';

            try {
                // Create a query to order versions by timestamp in descending order (latest first)
                const q = query(getVersionsCollectionRef(appId), orderBy('timestamp', 'desc'));

                // Set up a real-time listener for version changes
                onSnapshot(q, (snapshot) => {
                    versionsList.innerHTML = ''; // Clear the current list
                    if (snapshot.empty) {
                        versionsList.innerHTML = '<div class="text-gray-500 text-center py-4">No versions found for this application.</div>';
                        return;
                    }
                    // Iterate through each version document and create a UI element
                    snapshot.forEach(doc => {
                        const version = doc.data();
                        const versionItem = document.createElement('div');
                        versionItem.id = `version-${doc.id}`; // Unique ID for the version item
                        versionItem.className = 'list-item bg-gray-100 hover:bg-blue-100 p-3 rounded-lg cursor-pointer transition duration-200 shadow-sm';
                        const date = new Date(version.timestamp); // Convert timestamp to Date object
                        versionItem.innerHTML = `
                            <p class="font-medium text-gray-700">Version: ${version.versionNumber}</p>
                            <p class="text-sm text-gray-500">${version.notes || 'No notes'}</p>
                            <p class="text-xs text-gray-400">${date.toLocaleString()}</p>
                        `;
                        // Attach click event to select the version
                        versionItem.onclick = () => selectVersion(appId, doc.id);
                        versionsList.appendChild(versionItem);
                    });
                });
            } catch (error) {
                console.error("Error loading versions:", error);
                versionsList.innerHTML = '<div class="text-red-500 text-center py-4">Error loading versions.</div>';
                showMessage("Error loading versions.", 4000);
            }
        }

        /**
         * Selects a version and loads its code content into the viewer.
         * @param {string} appId - The ID of the application.
         * @param {string} versionId - The ID of the selected version.
         */
        async function selectVersion(appId, versionId) {
            if (!isAuthReady || !appId || !versionId) {
                showMessage('Cannot load version. Authentication or IDs are missing.', 3000);
                return;
            }

            // Remove highlight from all version items
            document.querySelectorAll('#versionsList > div').forEach(item => {
                item.classList.remove('bg-blue-200', 'border-blue-500', 'border-2');
                item.classList.add('bg-gray-100');
            });
            // Add highlight to the newly selected version item
            const selectedVersionElement = document.getElementById(`version-${versionId}`);
            if (selectedVersionElement) {
                selectedVersionElement.classList.remove('bg-gray-100');
                selectedVersionElement.classList.add('bg-blue-200', 'border-blue-500', 'border-2');
            }

            displayedCode.textContent = 'Loading code...'; // Show loading state in the viewer
            try {
                // Query for files within the selected version. For MVP, we expect one main file.
                const filesQuery = query(getFilesCollectionRef(appId, versionId));
                const filesSnapshot = await getDocs(filesQuery);

                if (!filesSnapshot.empty) {
                    const fileDoc = filesSnapshot.docs[0]; // Get the first (and typically only) file document
                    const fileData = fileDoc.data();
                    displayedCode.textContent = fileData.content || 'No code content found.';
                    // TODO: Integrate a syntax highlighter library here (e.g., Prism.js, highlight.js)
                    // Example with Prism.js (requires including Prism.js CSS and JS):
                    // displayedCode.className = `language-${fileData.fileType.split('/')[1] || 'markup'}`; // Set language class
                    // Prism.highlightElement(displayedCode);
                } else {
                    displayedCode.textContent = 'No code found for this version.';
                }
            } catch (error) {
                console.error("Error loading code for version:", error);
                displayedCode.textContent = 'Error loading code.';
                showMessage("Error loading code.", 4000);
            }
        }

        // --- Action Functions ---

        /**
         * Handles saving a new version of the current application to Firestore.
         */
        async function saveVersion() {
            if (!isAuthReady) {
                showMessage('Please wait for authentication to be ready.', 3000);
                return;
            }
            if (!currentAppId) {
                showMessage('Please select an application first to save a version.', 3000);
                return;
            }

            const codeContent = codeEditor.value.trim();
            const versionNotes = versionNotesInput.value.trim();

            if (!codeContent) {
                showMessage('Code content cannot be empty.', 3000);
                return;
            }

            try {
                // Add a new version document to the versions sub-collection
                const newVersionRef = await addDoc(getVersionsCollectionRef(currentAppId), {
                    versionNumber: `v${Date.now()}`, // Simple version number using timestamp
                    notes: versionNotes || 'No notes provided',
                    timestamp: Date.now(), // Timestamp for ordering and display
                    // userId: userId, // Optional: store the user who created this version
                });
                console.log("New version added with ID:", newVersionRef.id);

                // Add the code content as a file sub-document under the new version
                await addDoc(getFilesCollectionRef(currentAppId, newVersionRef.id), {
                    filename: 'main.txt', // For MVP, assuming one main file
                    fileType: 'text/plain', // Can be dynamically determined later (e.g., 'text/html', 'application/javascript')
                    content: codeContent,
                });
                console.log("Code content saved for version:", newVersionRef.id);

                showMessage('New version saved successfully!', 3000);
                codeEditor.value = ''; // Clear the editor after successful save
                versionNotesInput.value = ''; // Clear the notes input
                // The `onSnapshot` listener for versions will automatically update the list.
            } catch (error) {
                console.error("Error saving version:", error);
                showMessage('Failed to save version. Check console for details.', 5000);
            }
        }

        /**
         * Copies the currently displayed code to the user's clipboard.
         */
        function copyCode() {
            const codeToCopy = displayedCode.textContent;
            // Check if there's actual code to copy
            if (codeToCopy === 'Select a version to view its code.' || codeToCopy === 'Loading code...' || codeToCopy === 'Error loading code.' || codeToCopy === 'No code found for this version.' || codeToCopy === 'No code content found.') {
                showMessage('No code to copy or code is not loaded yet.', 3000);
                return;
            }
            try {
                // Use a temporary textarea to copy text, as navigator.clipboard.writeText()
                // might have restrictions in an iframe environment.
                const textArea = document.createElement("textarea");
                textArea.value = codeToCopy;
                // Position off-screen to avoid visual disruption
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select(); // Select the text
                document.execCommand('copy'); // Execute the copy command
                textArea.remove(); // Remove the temporary textarea
                showMessage('Code copied to clipboard!', 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessage('Failed to copy code. Please try manually.', 4000);
            }
        }

        /**
         * Shows the modal dialog for adding a new application.
         */
        function showAddNewAppModal() {
            newAppNameInput.value = ''; // Clear the input field when showing the modal
            addNewAppModal.classList.remove('hidden'); // Make the modal visible
        }

        /**
         * Hides the modal dialog for adding a new application.
         */
        function hideAddNewAppModal() {
            addNewAppModal.classList.add('hidden'); // Hide the modal
        }

        /**
         * Adds a new application document to Firestore.
         */
        async function addNewApplication() {
            if (!isAuthReady) {
                showMessage('Please wait for authentication to be ready.', 3000);
                return;
            }
            const appName = newAppNameInput.value.trim();
            if (!appName) {
                showMessage('Application name cannot be empty.', 3000);
                return;
            }

            try {
                // Add a new document to the applications collection
                await addDoc(getApplicationsCollectionRef(), {
                    name: appName,
                    createdAt: Date.now(), // Timestamp for creation
                    // createdBy: userId, // Optional: store the user who created this app
                });
                showMessage(`Application "${appName}" added successfully!`, 3000);
                hideAddNewAppModal(); // Close the modal
                // The `onSnapshot` listener for applications will automatically update the list.
            } catch (error) {
                console.error("Error adding new application:", error);
                showMessage('Failed to add new application. Check console for details.', 5000);
            }
        }

        // --- Event Listeners ---
        saveVersionBtn.addEventListener('click', saveVersion);
        copyCodeBtn.addEventListener('click', copyCode);
        addNewAppBtn.addEventListener('click', showAddNewAppModal);
        confirmNewAppBtn.addEventListener('click', addNewApplication);
        cancelNewAppBtn.addEventListener('click', hideAddNewAppModal);

        // Initial load of applications is triggered by the onAuthStateChanged listener
        // once authentication is confirmed ready.
    </script>
</body>
</html>
